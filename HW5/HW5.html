<!DOCTYPE html>
<html>
<style>
	#info {
		position: absolute;
		top: 0px;
		width: 100%;
		padding: 10px;
		text-align: center;
		color: #ffff00
	}

	body {
		overflow: hidden;
	}
</style>

<head>
	<title></title>
	<div id="info">HW4
		<br></div>
</head>

<body>


	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js"></script>
	<script src="https://dl.dropboxusercontent.com/u/3587259/Code/Threejs/OrbitControls.js"></script>
	<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
	<script src="https://idmakers.github.io/stats.js//build/stats.min.js"></script>

	<script>
		var camera, scene, renderer, controls;
		var puck;
		var cube;
		var raycaster;
		var mouse = new THREE.Vector2();
		var pickables = [];
		var angle = 0;
		// steer related
		var target = new THREE.Vector3();
		var targetMesh;
		var camera, scene, renderer, light, controls;
		var missile;
		var pos, vel, force;
		var obCen = [];
		var obRad = 50;
		var group = new THREE.Object3D();
		var clock = new THREE.Clock();
		var target;
		var maxSpeed = 60;
		var maxForce = 10

		init();
		animate();

		function buildMissile() {
			var missile = new THREE.Object3D();
			var normalMat = new THREE.MeshNormalMaterial();
			var tip = new THREE.Mesh(new THREE.CylinderGeometry(0, 5, 10, 20), normalMat);
			var body = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 20, 20), normalMat);
			body.add(tip);
			tip.position.y = 10 / 2 + 20 / 2;
			body.position.y = 20 / 2;

			missile.add(body);
			missile.rotation.z = -Math.PI / 2;
			var missileFrame = new THREE.Object3D();
			missileFrame.add(missile);
			return missileFrame;
		}



		function init() {
			scene = new THREE.Scene();

			camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
			camera.position.z = 500;
			scene.add(camera);

			var gridXZ = new THREE.GridHelper(200, 10);
			gridXZ.setColors(new THREE.Color(0x261818), new THREE.Color(0xffffff));
			scene.add(gridXZ);

			renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.setClearColor(0x888888);

			controls = new THREE.OrbitControls(camera, renderer.domElement);

			document.body.appendChild(renderer.domElement);


			/////////////////////////////////////////////////////////////////////
			plane = new THREE.Mesh(new THREE.PlaneGeometry(400, 400), new THREE.MeshBasicMaterial({
				visible: false
			}));
			scene.add(plane);
			plane.rotation.x = -Math.PI / 2;
			pickables = [plane];

			puck = new THREE.Mesh(new THREE.CylinderGeometry(20, 20, 60), new THREE.MeshNormalMaterial());
			scene.add(puck);
			pos = new THREE.Vector3();
			vel = new THREE.Vector3(100, 0, 0);
			force = new THREE.Vector3();
			target = puck.position;
			raycaster = new THREE.Raycaster();
			document.addEventListener('mousedown', onDocumentMouseDown, false);
			//////////////////////////////////////////////

			missile = buildMissile();
			pos = new THREE.Vector3();
			vel = new THREE.Vector3(120, 0, 0);
			force = new THREE.Vector3();

			missile.rotation.y = 0; //-Math.PI/4;
			missile.rotation.z = Math.PI / 6;
			missile.position.set(-280, 0, -280);

			pos.copy(missile.position);
			vel.applyEuler(missile.rotation);

			scene.add(missile);
			/////////////////////////////////////

			obCen.push(new THREE.Vector3(0, 100, 100));
			obCen.push(new THREE.Vector3(-100, 100,0 ));
			obCen.push(new THREE.Vector3(100,100, 0));
			obCen.push(new THREE.Vector3(0, 100, -100));

			var ob1 = new THREE.Mesh(new THREE.CircleGeometry(obRad, 20));
			ob1.position.z = -100;
			var ob2 = new THREE.Mesh(new THREE.CircleGeometry(obRad, 20));
			ob2.position.z = 100;
			var ob3 = new THREE.Mesh(new THREE.CircleGeometry(obRad, 20));
			ob3.position.x = -100;
			var ob4 = new THREE.Mesh(new THREE.CircleGeometry(obRad, 20));
			ob4.position.x = 100;
			group.add(ob1);
			group.add(ob2);
			group.add(ob3);
			group.add(ob4);
		  group.position.y = 100;
			scene.add(group);




		}


		function onDocumentMouseDown(event) {

			// PICKING DETAILS:
			// convert mouse.xy = [-1,1]^2 (NDC)
			// unproject (mouse.xy, 1) to a point on the far plane (in world coordinate)
			// set raycaster (origin, direction)
			// find intersection objects, (closest first)
			// each record as
			// [ { distance, point, face, faceIndex, object }, ... ]

			event.preventDefault();
			mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
			mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

			// find intersections
			raycaster.setFromCamera(mouse, camera);
			var intersects = raycaster.intersectObjects(pickables);
			if (intersects.length > 0) {
				puck.position.copy(intersects[0].point);
			}

		}

		function vectorClamp(v, vMax) {
			if (v.length() > vMax)
				v.setLength(vMax);
		}



		function animate() {
			controls.update();
			puck.position.y = 30;
			var dt = clock.getDelta();

			// if reach 50, move to target (280,50,280)
			if (target === null && pos.y > 50) {
				// start seek
				target = puck.position;
			}

			if (target !== null && target.distanceTo(pos) < 100) {
				// start seek
				target = puck.position;
			}

			if (target !== null && target.distanceTo(pos) < 50) {
				vel.set(0, 0, 0);
				target = null;
				force.set(0, 0, 0);
				console.log('bomb');
			}

			if (target !== null)
				force = target.clone().sub(pos).setLength(maxSpeed).sub(vel);

			vectorClamp(force, maxForce);
			vel.add(force.clone().multiplyScalar(dt));
			vectorClamp(vel, maxSpeed);
			pos.add(vel.clone().multiplyScalar(dt));

			missile.position.copy(pos);

			// set orientation
			var quaternion = new THREE.Quaternion();
			var localDir = new THREE.Vector3(1, 0, 0);
			var angle = localDir.angleTo(vel);
			var axis = new THREE.Vector3();
			axis.crossVectors(localDir, vel).normalize();
			quaternion.setFromAxisAngle(axis, angle);
			missile.quaternion.copy(quaternion);

			requestAnimationFrame(animate);
			render();
		}

		function render() {
			renderer.render(scene, camera);
		}
	</script>
</body>

</html>
